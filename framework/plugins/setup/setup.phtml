<?php

namespace Ephect\Plugins\Setup;

use function Ephect\Hooks\useEffect;

define('SERVER_ERROR', 'Something went wrong, please check the server setup');

function Setup()
{

    function makeResponse(array $response): string
    {
        header('Content-Type: application/json');
        return json_encode($response);
    };

    function fixRewriteBase(string &$response): void
    {
        $srv = new SetupService;

        $ok = $srv->findFramework();
        $rewritebase = $srv->fixRewritBase();
        $response = makeResponse(
            [
                'result' => ($rewritebase !== null) ? $rewritebase : SERVER_ERROR,
                'error' => ($rewritebase === null)
            ]
        );
    };

    function installEphectJS(string &$response): void
    {
        $srv = new SetupService;

        $ok = $srv->installPhinkJS();
        $response = makeResponse(
            [
                'result' => ($ok) ? 'Javascript framework installation successful' : SERVER_ERROR,
                'error' => !$ok
            ]
        );
    };

    function makeIndex(string &$response): void
    {
        $srv = new SetupService;

        $ok = $srv->makeBootstrap();
        $ok = $ok && $srv->makeIndex();
        $response = makeResponse(
            [
                'result' => ($ok) ? 'Index created' : SERVER_ERROR,
                'error' => !$ok
            ]
        );
    };

    useEffect(function() use (/* string */ &$response) {

        $action = isset($_REQUEST['action']) ? $_REQUEST['action'] : null;

        if ($action === 'rewrite') {
            fixRewriteBase($response);
        }

        if ($action === 'js') {
            installEphectJS($response);
        }

        if ($action === 'index') {
            makeIndex($response);
        }


    });

    return (<<< HTML

        {? if ({response} !== '') { ?}
            {{ response }}
        {? return ''; } ?}
            <header>
                <h1>
                    Ephect Setup
                </h1>
            </header>
            <main>
                <section>
                    <h3>
                        Processing through steps, please wait ...
                    </h3>
                </section>
                <section>
                    <div class="border">&nbsp;</div>
                    <div class="content">
                        <div class="subborder">&nbsp;</div>

                        <ul>
                            <li>
                                <div class="caption">Fix .htaccess RewriteBase</div>
                                <div data-step="1" class="step uncheck">...</div>
                            </li>
                            <li>
                                <div class="caption">Download JS framework</div>
                                <div data-step="2" class="step uncheck">...</div>
                            </li>
                            <li>
                                <div class="caption">Make the index file</div>
                                <div data-step="3" class="step uncheck">...</div>
                            </li>
                        </ul>
                        <div class="subborder">&nbsp;</div>

                    </div>
                    <div class="border">&nbsp;</div>
                    <div class="clear"></div>
                </section>
                <section>
                    <h3>
                        You will be redirected to the Welcome page
                    </h3>
                </section>
            </main>
            <footer>

            </footer>

    HTML);
}
